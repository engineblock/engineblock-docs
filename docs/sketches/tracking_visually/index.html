<!DOCTYPE html>
  
  
  
  
   <html class="no-js"> 

  <head lang="en-us">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=10" />
    <title>Tracking Diagrams - EngineBlock</title>
    <meta name="generator" content="Hugo 0.30.2" />

    
    <meta name="description" content="EngineBlock Docs">
    
    <link rel="canonical" href="http://docs.engineblock.io/sketches/tracking_visually/">
    

    <meta property="og:url" content="http://docs.engineblock.io/sketches/tracking_visually/">
    <meta property="og:title" content="EngineBlock">
    <meta property="og:image" content="http://docs.engineblock.io/images/engineblock_128.png">
    <meta name="apple-mobile-web-app-title" content="EngineBlock">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="shortcut icon" type="image/x-icon" href="http://docs.engineblock.io/images/engineblock_32.png">
    <link rel="icon" type="image/x-icon" href="http://docs.engineblock.io/images/engineblock_32.png">

    <style>
      @font-face {
        font-family: 'Icon';
        src: url('http://docs.engineblock.io/fonts/icon.eot');
        src: url('http://docs.engineblock.io/fonts/icon.eot')
               format('embedded-opentype'),
             url('http://docs.engineblock.io/fonts/icon.woff')
               format('woff'),
             url('http://docs.engineblock.io/fonts/icon.ttf')
               format('truetype'),
             url('http://docs.engineblock.io/fonts/icon.svg')
               format('svg');
        font-weight: normal;
        font-style: normal;
      }
    </style>

    <link rel="stylesheet" href="http://docs.engineblock.io/stylesheets/application.css">
    <link rel="stylesheet" href="http://docs.engineblock.io/stylesheets/temporary.css">
    <link rel="stylesheet" href="http://docs.engineblock.io/stylesheets/palettes.css">
    <link rel="stylesheet" href="http://docs.engineblock.io/stylesheets/images.css">

    <link rel="stylesheet" href="http://docs.engineblock.io/stylesheets/highlight/highlight.css">

    
    
    
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:400,700|Roboto&#43;Mono">
    <style>
      body, input {
        font-family: 'Roboto', Helvetica, Arial, sans-serif;
      }
      pre, code {
        font-family: 'Roboto Mono', 'Courier New', 'Courier', monospace;
      }
    </style>

    
    <script src="http://docs.engineblock.io/javascripts/modernizr.js"></script>

    

  
    
    

    
    
    <script src="http://docs.engineblock.io//modules/viz/viz.js"></script>
    

    
    

    
    
    <script src="http://docs.engineblock.io//modules/jssequence/webfont.js"></script>
    <script src="http://docs.engineblock.io//modules/jssequence/snap.svg-min.js"></script>
    <script src="http://docs.engineblock.io//modules/jssequence/underscore-min.js"></script>
    <script src="http://docs.engineblock.io//modules/jssequence/sequence-diagram.js"></script>
    <link href="http://docs.engineblock.io//modules/jssequence/sequence-diagram-min.css" rel="stylesheet" />
    

    
    

    
    

    
    
    
    
    

    
    


      
    
    <link href="http://docs.engineblock.io//modules/annotatorjs/annotator.css" rel="stylesheet" />
    <script src="http://docs.engineblock.io//modules/annotatorjs/jquery-3.2.1.js"></script>
    <script src="http://docs.engineblock.io//modules/annotatorjs/annotator.js"></script>
    <script>
        var app = new annotator.App();
        app.include(annotator.ui.main);
        app
            .start()
            .then(function() {
                app.annotations.load();
            });
    </script>


  </head>
  <body class="palette-primary-grey palette-accent-teal">




<div class="backdrop">
	<div class="backdrop-paper"></div>
</div>

<input class="toggle" type="checkbox" id="toggle-drawer">
<input class="toggle" type="checkbox" id="toggle-search">
<label class="toggle-button overlay" for="toggle-drawer"></label>

<header class="header">
	<nav aria-label="Header">
  <div class="bar default">
    <div class="button button-menu" role="button" aria-label="Menu">
      <label class="toggle-button icon icon-menu" for="toggle-drawer">
        <span></span>
      </label>
    </div>
    <div class="stretch">
      <div class="title">
        Tracking Diagrams
      </div>
    </div>

    

    
    <div class="button button-github" role="button" aria-label="GitHub">
      <a href="https://github.com/engineblock/engineblock" title="@engineblock/engineblock on GitHub" target="_blank" class="toggle-button icon icon-github"></a>
    </div>
    
    
        
  </div>
  <div class="bar search">
    <div class="button button-close" role="button" aria-label="Close">
      <label class="toggle-button icon icon-back" for="toggle-search"></label>
    </div>
    <div class="stretch">
      <div class="field">
        <input class="query" type="text" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck>
      </div>
    </div>
    <div class="button button-reset" role="button" aria-label="Search">
      <button class="toggle-button icon icon-close" id="reset-search"></button>
    </div>
  </div>
</nav>
</header>

<main class="main">
	<div class="drawer">
		<nav aria-label="Navigation">
  <a href="http://docs.engineblock.io/" class="project">
    <div class="banner">
      
        <div class="logo">
          <img src="http://docs.engineblock.io/images/engineblock_128.png">
        </div>
      
      <div class="name">
        <strong>EngineBlock </strong>
        
      </div>
    </div>
  </a>

  <div class="scrollable">
    <div class="wrapper">
      

      <div class="toc">
        
        <ul>
          




<li>
  
    



<a  title="EngineBlock" href="http://docs.engineblock.io/">
	
	EngineBlock
</a>



  
</li>



<li>
  
    



<a  title="Quickstart" href="http://docs.engineblock.io/quickstart/">
	
	Quickstart
</a>



  
</li>



<li>
  
    <span class="section">User Guide</span>
    <ul>
      
        
        



<a  title="Concepts" href="http://docs.engineblock.io/user-guide/concepts/">
	
	Concepts
</a>



      
        
        



<a  title="Command Line" href="http://docs.engineblock.io/user-guide/command_line/">
	
	Command Line
</a>



      
        
        



<a  title="CLI Scripting" href="http://docs.engineblock.io/user-guide/cli_scripting/">
	
	CLI Scripting
</a>



      
        
        



<a  title="Metrics" href="http://docs.engineblock.io/user-guide/metrics/">
	
	Metrics
</a>



      
        
        



<a  title="Scenario Scripting" href="http://docs.engineblock.io/user-guide/scripting/">
	
	Scenario Scripting
</a>



      
        
        



<a  title="YAML Config" href="http://docs.engineblock.io/user-guide/standard_yaml/">
	
	YAML Config
</a>



      
    </ul>
  
</li>



<li>
  
    <span class="section">Dev Guide</span>
    <ul>
      
        
        



<a  title="Activity Internals" href="http://docs.engineblock.io/dev-guide/activity_internals/">
	
	Activity Internals
</a>



      
        
        



<a  title="Building ActivityTypes" href="http://docs.engineblock.io/dev-guide/building_activities/">
	
	Building ActivityTypes
</a>



      
        
        



<a  title="Diag ActivityType" href="http://docs.engineblock.io/dev-guide/annotated_diag/">
	
	Diag ActivityType
</a>



      
        
        



<a  title="Project Structure" href="http://docs.engineblock.io/dev-guide/contributing/">
	
	Project Structure
</a>



      
        
        



<a  title="Scripting Extensions" href="http://docs.engineblock.io/dev-guide/scripting_extensions/">
	
	Scripting Extensions
</a>



      
        
        



<a  title="YAML Config API" href="http://docs.engineblock.io/dev-guide/standard_yam_devl/">
	
	YAML Config API
</a>



      
    </ul>
  
</li>


        </ul>
        

        
      </div>
    </div>
  </div>
</nav>

	</div>

	<article class="article">
		<div class="wrapper">
			<h1>Tracking Diagrams </h1>

			

<p>This section lays out visually some of the design challenges in the cycle
tracking design. The diagrams are very basic, but serve as a basis for
discussion and elaboration.</p>

<h2 id="scenario-a-b">Scenario: A -&gt; B</h2>



<div align="center" class="viz-text"><pre>
digraph sys1 {
 rankdir=LR;
 node[shape=box]
 edge[dir=out]
 state[label=&#34;Internal state&#34;];
 
 A -&gt; marker;
 marker -&gt; state;
 state -&gt; tracker;
 tracker -&gt; B;
}
</pre></div>
<script type="text/javascript" src="http://docs.engineblock.io/modules/viz/inithook-viz.js"></script>


<h2 id="internal-state">Internal State</h2>



<div align="center" class="viz-text"><pre>
digraph d {
a[shape=&#34;record&#34;,label=&#34;0|1|2|3|4|5|6|7|8|9|10|11|...&#34;];
}
</pre></div>
<script type="text/javascript" src="http://docs.engineblock.io/modules/viz/inithook-viz.js"></script>


<h3 id="pacing-data-only">Pacing Data Only</h3>

<p>For pacing purposes, in which a consuming tracker watches the state of a
producing marker, the only state that is necessary to record is whether a given
cycle has been completed. Ostensibly, in this mode the API only needs to support
the enumeration of a cycle, and not its status. However, since cycles can
complete in any order, and we do not want to force sequential serialization (as this
would be a tremendous deoptimization of concurrent performance), the ability
to pace cycles independently needs to be supported within some bound.
In this case, the binary state for each cylce only represents whether or not
it has been marked as completed. Uncompressed, this requires exactly one logical
bit per cycle, however the implementation may do something else internally.</p>



<div align="center" class="viz-text"><pre>
digraph d {
a[shape=&#34;record&#34;,label=&#34;&lt;0&gt;0|&lt;1&gt;1|&lt;2&gt;2|&lt;3&gt;3|&lt;4&gt;4|&lt;5&gt;5|&lt;6&gt;6|&lt;7&gt;7|&lt;8&gt;8|&lt;9&gt;9|...&#34;];
b[shape=&#34;record&#34;,label=&#34;&lt;0&gt;0|&lt;1&gt;1|&lt;2&gt;0|&lt;3&gt;0|&lt;4&gt;1|&lt;5&gt;1|&lt;6&gt;1|&lt;7&gt;0|&lt;8&gt;1|&lt;9&gt;0|...&#34;];
a:0-&gt;b:0; a:1-&gt;b:1; a:2-&gt;b:2; a:3-&gt;b:3; 
a:4-&gt;b:4; a:5-&gt;b:5; a:6-&gt;b:6; a:7-&gt;b:7;
a:8-&gt;b:8; a:9-&gt;b:9;
}
</pre></div>
<script type="text/javascript" src="http://docs.engineblock.io/modules/viz/inithook-viz.js"></script>


<h3 id="marking-data-too">Marking Data Too</h3>

<p>When recording some additional state, including an enumerable outcome, it is necessary
to associate a value with each cycle completion. We are planning to allow these values
to be in the range of 1..127, inclusive. The zero value will be reserved to mean
<em>unmarked</em>, or in effect <em>incomplete</em>. In the example below, cycle 7 has not been marked
yet.</p>



<div align="center" class="viz-text"><pre>
digraph d {
a[shape=&#34;record&#34;,label=&#34;&lt;0&gt;0|&lt;1&gt;1|&lt;2&gt;2|&lt;3&gt;3|&lt;4&gt;4|&lt;5&gt;5|&lt;6&gt;6|&lt;7&gt;7|&lt;8&gt;8|&lt;9&gt;9|...&#34;];
b[shape=&#34;record&#34;,label=&#34;&lt;0&gt;8|&lt;1&gt;4|&lt;2&gt;1|&lt;3&gt;1|&lt;4&gt;4|&lt;5&gt;4|&lt;6&gt;8|&lt;7&gt;0|&lt;8&gt;9|&lt;9&gt;123|...&#34;];
a:0-&gt;b:0; a:1-&gt;b:1; a:2-&gt;b:2; a:3-&gt;b:3; 
a:4-&gt;b:4; a:5-&gt;b:5; a:6-&gt;b:6; a:7-&gt;b:7;
a:8-&gt;b:8; a:9-&gt;b:9;
}
</pre></div>
<script type="text/javascript" src="http://docs.engineblock.io/modules/viz/inithook-viz.js"></script>


<h2 id="segmenting-state">Segmenting State</h2>

<p>When using buffered counting to track completion of a range of cycle values, it
is necessary to break the number line into a set of uniformly sized intervals.
This allows for modulo-style assignment of a cycle number to a marking bucket.
For example, if you were tracking full completion of every 8 cycles in a bucket,
then you would break the cycles into logical units like this, with a simple &ldquo;mod 8&rdquo; operation,
which is also equivalent to masking off all but 3 LSBs.</p>



<div align="center" class="viz-text"><pre>
digraph d {
rankdir=LR;
0[shape=&#34;record&#34;,label=&#34;{0|1|2|3|4|5|6|7}&#34;];
1[shape=&#34;record&#34;,label=&#34;{8|9|10|11|12|13|14|15}&#34;];
2[shape=&#34;record&#34;,label=&#34;{16|...}&#34;];
0-&gt;1;
1-&gt;2;
}   
</pre></div>
<script type="text/javascript" src="http://docs.engineblock.io/modules/viz/inithook-viz.js"></script>


<p>In this case, it is possible to efficiently pace each segment as a unit, by allowing for
efficient concurrent counting algorithms to operate exclusively on the segment state
without exposing it yet to the reader side.</p>

<h2 id="stride-and-filtering">Stride and Filtering</h2>

<p>When using cycle stride of greater than 1, a strategy that causes a number of
cycles to be processed within each thread, filtering may become a challenge.
This is because you may want the same type of operational grouping within a downstream
thread as you have in an upstream thread.</p>

<p>Here is the current flow of stride, as managed by a thread harness (AKA a Motor in EB parlance),
an input, and an action:</p>



<div class="jssequence-text"><pre>
Motor-&gt;Input: get[stride=5]
Input-&gt;Motor: startsat=25
Note over Motor: foreach v in [25,30)\n(contiguously)
Motor-&gt;Action: runCycle(v)
Action-&gt;Motor: result
</pre></div>
<script type="text/javascript" src="http://docs.engineblock.io/modules/jssequence/inithook-jssequence.js"></script>


<p>That means that any filtering needs to be applied at the motor level, after applying stride, but
before providing the cycles to the Action. This is also in keeping with the desire to avoid
injecting inter-activity flow logic into the programming scope of individual activities.</p>

<p>The revised <em>stride &amp; filter</em> scenario looks like this:</p>



<div class="jssequence-text"><pre>
Motor-&gt;Input: get[stride=5]
Input-&gt;Motor: startsat=25
Note over Motor: foreach v in [25,30)\n(matching filter)
Motor-&gt;Action: runCycle(v)
Action-&gt;Motor: result
</pre></div>
<script type="text/javascript" src="http://docs.engineblock.io/modules/jssequence/inithook-jssequence.js"></script>


<h2 id="tracking-highest-contiguous">Tracking Highest Contiguous</h2>

<p>When marking an array, when cycles can complete out of order, it is useful to track
the highest contiguous value that has been completed. To do this efficiently, CAS
can be employed to do an almost free &ldquo;pull up&rdquo; to the current value when the most
max contiguous value was already one less than the current marking cycle.
This does not, however, handle the case of fast-forwarding the contiguous count
according to cycles that have already been marked. Also, because the bytebuffer is
not atomic or volatile itself, a more resilient check needs to be added to the
max contiguous property that will eagerly update when asked.</p>

<h2 id="implementation-sketch">Implementation Sketch</h2>

<p><img src="http://docs.engineblock.io/diagrams/cycle_tracking.png#center" alt="Tracking Extent" /></p>

<p>This diagram shows a series of tracking extents. Each one is simply a buffer of
result codes.</p>

<h3 id="locking-and-signals">Locking and Signals</h3>

<p>Locking should be kept to a minimum. The only time locks should be used at all is when there
is a blocking state that would otherwise consume resources in an idle loop, and for which
there is a proper and coherent signaling scheme available.</p>

<ul>
<li>nowMarking signal should be set any time a new extent is added.
<br /></li>
</ul>

<h3 id="marking">Marking</h3>

<p>When a marker attempts to mark a cycle of an extent:</p>

<ol>
<li>Mark the correct and active extent if possible.</li>
<li>If the marked extent was completed, attempt to activate a serving extent, but only
if the serving extent was not set (atomically). If succesful, signal nowServing.</li>
<li>If the marked extent was completed, add another extent and signal nowMarking.</li>
<li>If an active extent was marked, return success</li>
<li>Add an extent, if the the maxExtents limit is not reached.</li>
<li>If an extent was added, retry request.</li>
<li>If an extent was not added, block for nowMarking state, when signaled, retry request.</li>
</ol>

<h3 id="reading">Reading</h3>

<p>When a reader attempts to read a segment of an extent:
1. Acquire the serving extent.
2. If the serving extent is not defined, then block awaiting nowServing state.
3. If all cycles are consumed from the current extent, then advance the servingExtent
   if possible.
4. When a serving extent is advanced, then signal nowMarking, in case  extent limit
   opens up new marking extents.</p>

<p>The important details are as follows:</p>

<ol>
<li>No extent may be read from by a consumer until it has been fully filled.</li>
<li>The only extent that may be read from at any one time is the serving extent.
That is the lowest extent that has been filled and not fully served.</li>
<li>Lock-free readers and writers</li>
<li>A fixed number of extents is maintained at all times.</li>
<li>It is still up to the consumer of cycle codes to determine when to stop reading
cycles.</li>
</ol>

<p>=======</p>

<h2 id="performance-strategies">Performance Strategies</h2>

<ol>
<li>Track the highest contiguous completed cycle as well as the highest completed cycle.
allowing for fine-grained queries on state only if they are the same.</li>
<li>Use CAS or LongAdder for counters. For CAS, observing the return value can be used as
an incrementing state tracker for contiguity. For example, a successful CAS +1 operation
represents a succesful advance to the current position, and a failed one represents
that the &ldquo;highest&rdquo; value was not at the right position to advance.</li>
</ol>


			<aside class="copyright" role="note">
				
				&copy; 2017 APL 2.0 &ndash;
				
				Documentation built with
				<a href="https://www.gohugo.io" target="_blank">Hugo</a>
				using the
				<a href="http://github.com/digitalcraftsman/hugo-material-docs" target="_blank">Material</a> theme.
			</aside>

			<footer class="footer">
				

<nav class="pagination" aria-label="Footer">
  <div class="previous">
  
      <a href="http://docs.engineblock.io/sketches/scripting_histograms/" title="Scripting Histograms">
        <span class="direction">
          Previous
        </span>
        <div class="page">
          <div class="button button-previous" role="button" aria-label="Previous">
            <i class="icon icon-back"></i>
          </div>
          <div class="stretch">
            <div class="title">
              Scripting Histograms
            </div>
          </div>
        </div>
      </a>
  
  </div>

  <div class="next">
  
      <a href="http://docs.engineblock.io/sketches/vegatest/" title="Vega Test">
        <span class="direction">
          Next
        </span>
        <div class="page">
          <div class="stretch">
            <div class="title">
              Vega Test
            </div>
          </div>
          <div class="button button-next" role="button" aria-label="Next">
            <i class="icon icon-forward"></i>
          </div>
        </div>
      </a>
  
  </div>
</nav>





			</footer>
		</div>
	</article>

	<div class="results" role="status" aria-live="polite">
		<div class="scrollable">
			<div class="wrapper">
				<div class="meta"></div>
				<div class="list"></div>
			</div>
		</div>
	</div>
</main>

    <script>
    
      var base_url = '';
      var repo_id  = '';
    
    </script>

    <script src="http://docs.engineblock.io/javascripts/application.js"></script>
    

    <script>
      /* Add headers to scrollspy */
      var headers   = document.getElementsByTagName("h2");
      var scrollspy = document.getElementById('scrollspy');

      if(scrollspy) {
        if(headers.length > 0) {
          for(var i = 0; i < headers.length; i++) {
            var li = document.createElement("li");
            li.setAttribute("class", "anchor");

            var a  = document.createElement("a");
            a.setAttribute("href", "#" + headers[i].id);
            a.setAttribute("title", headers[i].innerHTML);
            a.innerHTML = headers[i].innerHTML;

            li.appendChild(a)
            scrollspy.appendChild(li);
          }
        } else {
          scrollspy.parentElement.removeChild(scrollspy)
        }


        /* Add permanent link next to the headers */
        var headers = document.querySelectorAll("h1, h2, h3, h4, h5, h6");

        for(var i = 0; i < headers.length; i++) {
            var a = document.createElement("a");
            a.setAttribute("class", "headerlink");
            a.setAttribute("href", "#" + headers[i].id);
            a.setAttribute("title", "Permanent link")
            a.innerHTML = "¶";
            headers[i].appendChild(a);
        }
      }
    </script>

    

    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.8.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>
</html>

